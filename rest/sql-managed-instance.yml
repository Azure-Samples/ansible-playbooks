# Description
# ===========
# This playbook create an Azure VM with public IP, and open 22 port for SSH

- name: Create Azure VM
  hosts: localhost
  connection: local
  vars:
    resource_group: zimsmanagedthird
    virtual_network: mivirtualnet
    route_table: miroutetable
    subnet: misubnet
    managed_instance: mibyansible
    location: eastus
  tasks:

  - name: Create a resource group
    azure_rm_resourcegroup:
      name: "{{ resource_group }}"
      location: "{{ location }}"

  - name: Create virtual network
    azure_rm_virtualnetwork:
      resource_group: "{{ resource_group }}"
      name: "{{ virtual_network }}"
      address_prefixes: "10.0.0.0/16"

  - name: Create route table using REST as no module available
    azure_rm_resource:
      api_version: '2018-04-01'
      resource_group: "{{ resource_group }}"
      provider: network
      resource_type: routetables
      resource_name: "{{ route_table }}"
      body:
        location: "{{ location }}"
        properties:
          routes:
            - name: default
              properties:
                addressPrefix: 0.0.0.0/0
                nextHopType: Internet
    register: output

  - name: Create subnet using REST as current module doesn't support referring route tables
    azure_rm_resource:
      api_version: '2018-04-01'
      resource_group: "{{ resource_group }}"
      provider: network
      resource_type: virtualnetworks
      resource_name: "{{ virtual_network }}"
      subresource:
        - type: subnets
          name: "{{ subnet }}"
      body:
        properties: 
          addressPrefix: 10.0.0.0/16
          routeTable:
            id: "{{ output.response.id }}"
    register: output
  
  - name: Create managed instance
    azure_rm_resource:
      api_version: '2015-05-01-preview'
      resource_group: zimssqlmanaged
      provider: sql
      resource_type: managedinstances
      resource_name: "{{ managed_instance }}"
      body:
        tags: 
          tagKey1: TagValue1
        location: eastus
        sku: 
          name: "GP_Gen4"
          tier: GeneralPurpose
          capacity: 1
        properties: 
          fullyQualifiedDomainName: "{{ managed_instance }}.database.windows.net"
          administratorLogin: dummylogin
          administratorLoginPassword: "Pa$$w0rd12345678"
          subnetId: "{{ output.response.id }}"
          vCores: 8
          storageSizeInGB: 32
          licenseType: BasePrice

