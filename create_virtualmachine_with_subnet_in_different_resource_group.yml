# Description
# ===========
# This playbook create an Azure VM with public IP, and subnet in another resource group.
# This Script will create two resource group, defined by variables resource_group and resource_group_secondary. Then it creates VM in resource_group and virtual network with defined subnets,nsg rules in resource_group_secondary.
# To be able to run this script you will need to be in active session of azure subscription where you want to create this infrastruture. You have two options to achive this
# 1. Using Azure cloud shell, Azure cloud shell automatically logs you in your azure subscription so you need not to do anything extra other than login to cluod shell and run the ansible-playbook command with -e switch to provide
# resource_group_name variable value. Login to cloud shell in VS code, upload the file to cloud drive and run the following command (replace yourusernameincloudshell with your username value).
# ansible-playbook /home/yourusernameincloudshell/create_virtualmachine_with_subnet_in_different_resource_group.yml -e "resource_group_name=ansible_test_rg"
# 2. Install ansible on your own linux box and login to azure (follow https://docs.microsoft.com/en-us/azure/virtual-machines/linux/ansible-install-configure?toc=%2Fen-us%2Fazure%2Fansible%2Ftoc.json&bc=%2Fen-us%2Fazure%2Fbread%2Ftoc.json#create-azure-credentials)
# After login to azure, issue the same ansible-playbook command after replacing the yml file location as per your local file location.

- name: Create Azure VM
  hosts: localhost
  connection: local
  vars:
    resource_group: "{{ resource_group_name }}"
    resource_group_secondary: createvmsubnetin2ndrg2
    vm_name: testvm
    location: eastus
#  roles:
#    - Azure.azure_preview_modules
  tasks:
  - name: Create a resource group
    azure_rm_resourcegroup:
        name: "{{ resource_group }}"
        location: "{{ location }}"
  - name: Create secondary resource group
    azure_rm_resourcegroup:
        name: "{{ resource_group_secondary }}"
        location: "{{ location }}"
  - name: Create virtual network
    azure_rm_virtualnetwork:
      resource_group: "{{ resource_group_secondary }}"
      name: "{{ vm_name }}"
      address_prefixes: "10.0.0.0/16"
  - name: Add subnet
    azure_rm_subnet:
      resource_group: "{{ resource_group_secondary }}"
      name: "{{ vm_name }}"
      address_prefix: "10.0.1.0/24"
      virtual_network: "{{ vm_name }}"
  - name: Create VM
    azure_rm_virtualmachine:
      resource_group: "{{ resource_group }}"
      name: "{{ vm_name }}"
      vm_size: Standard_DS1_v2
      admin_username: azureuser
      admin_password: Password@123
      virtual_network_resource_group: "{{ resource_group_secondary }}"
      virtual_network_name: "{{ vm_name }}"
      subnet_name: "{{ vm_name }}"
      image:
        offer: UbuntuServer
        publisher: Canonical
        sku: 16.04-LTS
        version: latest
